rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== AUTENTICAÇÃO & HELPERS ====================
    function isSignedIn() {
      return request.auth != null;
    }

    function userRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function userStore() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.storeId;
    }

    // ==================== TASKS (Tarefas com Fotos) ====================
    match /tasks/{taskId} {
      // READ: Vê tarefas da sua loja ou próprias
      allow read: if isSignedIn() && (
        resource.data.storeId == userStore() || 
        resource.data.responsible == request.auth.uid
      );

      // CREATE: Apenas admins podem criar tarefas
      allow create: if isSignedIn() && 
        (userRole() == 'admin' || userRole() == 'company' || userRole() == 'superadmin');

      // UPDATE: Tarefas da sua loja ou próprias (somente status/descrição, não fotos diretas)
      allow update: if isSignedIn() && (
        (resource.data.storeId == userStore()) ||
        (resource.data.responsible == request.auth.uid)
      ) && !request.resource.data.completionAttachments.hasChanged();

      // DELETE: Apenas admins da loja
      allow delete: if isSignedIn() && (
        userRole() == 'admin' || 
        userRole() == 'company' || 
        userRole() == 'superadmin'
      );
    }

    // ==================== PHOTO AUDIT LOGS (Trilha de Fotos) ====================
    match /photo_audit_logs/{logId} {
      // READ: Somente admins/company da loja podem ver logs
      allow read: if isSignedIn() && (
        userRole() in ['admin', 'company', 'superadmin'] || 
        resource.data.viewedBy == request.auth.uid
      ) && resource.data.storeId == userStore();

      // CREATE: Qualquer um pode registrar sua própria visualização
      allow create: if isSignedIn() && 
        request.resource.data.viewedBy == request.auth.uid &&
        request.resource.data.storeId == userStore();

      // UPDATE: Não permitido (logs são imutáveis)
      allow update: if false;

      // DELETE: Apenas superadmin pode deletar (auditoria)
      allow delete: if isSignedIn() && userRole() == 'superadmin';
    }

    // ==================== STORES CONFIG ====================
    match /stores_config/{storeId} {
      // READ: Apenas da mesma loja
      allow read: if isSignedIn() && userStore() == storeId;

      // CREATE/UPDATE: Apenas admins
      allow create, update: if isSignedIn() && 
        (userRole() == 'admin' || userRole() == 'company' || userRole() == 'superadmin');
    }

    // ==================== FEEDBACKS ====================
    match /feedbacks/{feedbackId} {
      // READ: Sender, receiver, ou admins da loja
      allow read: if isSignedIn() && (
        resource.data.sender == request.auth.uid ||
        resource.data.receiver == request.auth.uid ||
        userRole() in ['admin', 'company'] && resource.data.storeId == userStore()
      );

      // CREATE: Qualquer um pode enviar feedback
      allow create: if isSignedIn() && 
        request.resource.data.sender == request.auth.uid &&
        request.resource.data.storeId == userStore();

      // UPDATE: Sender e receivers
      allow update: if isSignedIn() && (
        resource.data.sender == request.auth.uid ||
        resource.data.receiver == request.auth.uid ||
        userRole() == 'admin'
      );
    }

    // ==================== COMPANIES ====================
    match /companies/{companyId} {
      // READ: Apenas company admin
      allow read: if isSignedIn() && userRole() in ['company', 'superadmin'];

      // CRUD: Apenas superadmin
      allow create, update, delete: if isSignedIn() && userRole() == 'superadmin';
    }

    // ==================== STORES ====================
    match /stores/{storeId} {
      // READ: Admins da loja ou company
      allow read: if isSignedIn() && 
        (userStore() == storeId || userRole() in ['company', 'superadmin']);

      // CRUD: Admin ou company
      allow create, update, delete: if isSignedIn() && 
        userRole() in ['admin', 'company', 'superadmin'];
    }

    // ==================== CATCH ALL (Deny) ====================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

/*
 * ==================== DEPLOYMENT INSTRUCTIONS ====================
 * 
 * 1. Go to Firebase Console → Your Project
 * 2. Navigate to: Firestore Database → Rules
 * 3. Replace content with this rules file
 * 4. Click "Publish"
 * 
 * ==================== SECURITY FEATURES ====================
 * 
 * ✅ Photos (completionAttachments):
 *    - Stored within Task documents
 *    - Only readable by: Task owner, Admin of store, Company admin
 *    - ViewedBy/UploadedBy tracked in photo_audit_logs
 * 
 * ✅ Audit Logs (photo_audit_logs):
 *    - Immutable (no updates allowed)
 *    - Each view/download/action is logged
 *    - Only readable by: admins and the person who viewed
 *    - Only superadmin can delete (for compliance)
 * 
 * ✅ Access Control:
 *    - Store-based (users can only see data from their store)
 *    - Role-based (ADMIN, COMPANY, SUPERADMIN, COLLABORATOR)
 *    - Task-based (collaborator can see only their tasks)
 * 
 * ✅ Immutable Trails:
 *    - Audit logs cannot be edited
 *    - Task photos cannot be directly updated via rules
 *    - Only Admin/Company can manage tasks
 * 
 * ==================== COMPLIANCE NOTES ====================
 * 
 * LGPD/GDPR Compliance considerations:
 * - Users can request deletion of their audit logs (add endpoint for this)
 * - Retention policy should be implemented (90 days for store deletion)
 * - Add encryption for sensitive photo data at rest
 * - Implement backup strategy for audit trails
 * 
 * ==================== TESTING THE RULES ====================
 * 
 * Firestore Rules Simulator steps:
 * 1. Go to Firestore → Rules → Test
 * 2. Set Auth UID (simulate user)
 * 3. Test read/write permissions
 * 
 * Example Test Cases:
 * - USER trying to read photo from another store: DENY ✓
 * - ADMIN reading photos from own store: ALLOW ✓
 * - USER trying to delete audit log: DENY ✓
 * - COMPANY admin viewing all photos: ALLOW ✓
 * 
 */
